<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Offline Support · Offix</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Offix provides first class support for performing GraphQL operations while offline. Mutations are held in a queue that is configured to hold requests while the client is offline. When the client goes offline for long periods of time they will still be able negotiate local updates with the server state thanks to powerful conflict resolution strategies."/><meta name="docsearch:version" content="0.9.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Offline Support · Offix"/><meta property="og:type" content="website"/><meta property="og:url" content="https://offix.dev/"/><meta property="og:description" content="Offix provides first class support for performing GraphQL operations while offline. Mutations are held in a queue that is configured to hold requests while the client is offline. When the client goes offline for long periods of time they will still be able negotiate local updates with the server state thanks to powerful conflict resolution strategies."/><meta property="og:image" content="https://offix.dev/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://offix.dev/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/offix-logo.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/offix-logo.png" alt="Offix"/><h2 class="headerTitleWithLogo">Offix</h2></a><a href="/versions"><h3>0.9.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/0.9.0/getting-started" target="_self">Documentation</a></li><li class=""><a href="https://github.com/aerogear/offix" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Getting Started</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.9.0/getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/docs/0.9.0/client-configuration">Client Configuration</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/0.9.0/offline-client">Offline Client</a></li><li class="navListItem"><a class="navItem" href="/docs/0.9.0/offix-cache">Client Cache</a></li><li class="navListItem"><a class="navItem" href="/docs/0.9.0/conflict-client">Conflicts Client</a></li><li class="navListItem"><a class="navItem" href="/docs/0.9.0/conflict-server">Conflict Server</a></li><li class="navListItem"><a class="navItem" href="/docs/0.9.0/release-notes">Release notes</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Offline Support</h1></header><article><div><span><p>Offix provides first class support for performing GraphQL operations while offline. Mutations are held in a queue that is configured to hold requests while the client is offline. When the client goes offline for long periods of time they will still be able negotiate local updates with the server state thanks to powerful conflict resolution strategies.</p>
<p>Offix-client offers a comprehensive set of features to perform data operations when offline. Thanks to the offline mutation store users can stage their changes to be replicated back to the server when they return online.</p>
<p>Please follow chapters bellow for more information.</p>
<h2><a class="anchor" aria-hidden="true" id="querying-local-cache"></a><a href="#querying-local-cache" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Querying local cache</h2>
<p>By default queries are cached based on the type and id field, and the results of performed queries are cached as well and they will be available when the client is offline.</p>
<p>Because of this, when mutations that can change query results are performed, the <code>refetchQueries</code> or update options of the mutate method should be used to ensure the local cache is kept up to date.</p>
<p>Offix makes your cache simple to manage, with out of the box cache helpers in <code>offix-cache</code> or by automatically wrapping these helpers in offix-client through the <code>OfflineClient</code> class.</p>
<p>To use the <code>offlineMutate</code> function, we first need to create our <code>MutationHelperOptions</code> object. This is an extension of Apollo's MutationOptions.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">const</span> { CacheOperation } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'offix-cache'</span>);

<span class="hljs-keyword">const</span> mutationOptions = {
  <span class="hljs-attr">mutation</span>: ADD_TASK,
  <span class="hljs-attr">variables</span>: {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'item title'</span>
  },
  <span class="hljs-attr">updateQuery</span>: {
    <span class="hljs-attr">query</span>: GET_TASKS,
    <span class="hljs-attr">variables</span>: {
      <span class="hljs-attr">filterBy</span>: <span class="hljs-string">'some filter'</span>
    }
  },
  <span class="hljs-attr">returnType</span>: <span class="hljs-string">'Task'</span>,
  <span class="hljs-attr">operationType</span>: CacheOperation.ADD,
  <span class="hljs-attr">idField</span>: <span class="hljs-string">'id'</span>
};
</code></pre>
<p>We can also provide more than one query to update in the cache by providing an array to the <code>updateQuery</code> parameter:</p>
<pre><code class="hljs css language-javascript">
<span class="hljs-keyword">const</span> mutationOptions = {
  ...
  updateQuery: [
    { <span class="hljs-attr">query</span>: GET_TASKS, <span class="hljs-attr">variables</span>: {} }
  ]
  ,
  ...
};
</code></pre>
<p>We then simply pass this object to <code>offlineMutate</code> and our cache is automatically kept up to date.</p>
<pre><code class="hljs css language-javascript">client.offlineMutate(mutationOptions);
</code></pre>
<p>If you do not wish to use the <code>offlineMutate</code> function you can also use the <code>createMutationOptions</code> function directly. This function provides an Apollo compatible <code>MutationOptions</code> object to pass to your pre-existing client.
This is shown below where <code>mutationOptions</code> is the same object shown in the above code example.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">const</span> { createMutationOptions } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'offix-cache'</span>);

<span class="hljs-keyword">const</span> options = createMutationOptions(mutationOptions);

client.mutate(options);
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="offline-workflow"></a><a href="#offline-workflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Offline Workflow</h2>
<p>When offline <code>client.mutate</code> function will return immediately after is called.
Returned promise will resolve into error (<code>catch</code> method is triggered).
Developers can detect if error is an offline error and watch for change to be replicated back to server.</p>
<p>Example:</p>
<pre><code class="hljs css language-javascript">client.mutate(...).catch(<span class="hljs-function">(<span class="hljs-params">error</span>)=&gt;</span> {
  <span class="hljs-comment">// 1. Detect if this was an offline error</span>
  <span class="hljs-keyword">if</span> (error.offline){
    <span class="hljs-comment">// 2. We can still track when offline change is going to be replicated.</span>
    error.watchOfflineChange().then(...)
  }
});
</code></pre>
<blockquote>
<p>Note: Additionally to watching individual mutations framework offers global offline listener that can be supplied when creating client.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="global-update-functions"></a><a href="#global-update-functions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Global Update Functions</h2>
<p>Apollo client holds all mutation parameters in memory. An offline Apollo client will continue to store mutation parameters and once online, it will restore all mutations to memory. Any Update Functions that are supplied to mutations cannot be cached by an Apollo client resulting in the loss of all optimisticResponses after a restart. Update functions supplied to mutations cannot be saved in the cache. As a result, all optimisticResponses will disappear from the application after a restart and it will only reappear when the Apollo client becomes online and successfully syncs with the server.</p>
<p>To prevent the loss of all optimisticResponses after a restart, you can configure the Update Functions to restore all optimisticResponses.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">const</span> updateFunctions = {
  <span class="hljs-comment">// Can contain update functions from each component</span>
  ...ItemUpdates,
  ...TasksUpdates
};

<span class="hljs-keyword">let</span> config = {
  <span class="hljs-attr">mutationCacheUpdates</span>: updateFunctions
};
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="making-modifications-when-offline"></a><a href="#making-modifications-when-offline" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Making modifications when offline</h2>
<p>Client provides queue that stores mutations performed when offline.
By default queue saves data in storage to be available after application restarts.
Queue will hold requests until application will come back online.</p>
<p>Developers can adjust how queue will process new mutations by supplying custom <code>NetworkStatus</code> implementation.</p>
<h2><a class="anchor" aria-hidden="true" id="listening-for-events"></a><a href="#listening-for-events" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Listening for Events</h2>
<p>It is possible to provide <code>offlineQueueListener</code> in config to be notified about offline related events:</p>
<pre><code class="hljs css language-javascript">client.registerOfflineEventListener({
  onOperationEnqueued(operation) {
    <span class="hljs-comment">// called when operation was placed on the queue</span>
  },
  <span class="hljs-attr">onOperationFailure</span>: <span class="hljs-function">(<span class="hljs-params">operation</span>) =&gt;</span> {
    <span class="hljs-comment">// called when the operation failed</span>
  },
  <span class="hljs-attr">onOperationSuccess</span>: <span class="hljs-function">(<span class="hljs-params">operation</span>) =&gt;</span> {
    <span class="hljs-comment">// called when the operation was fulfilled</span>
  },
  <span class="hljs-attr">onOperationRequeued</span>: <span class="hljs-function">(<span class="hljs-params">operation</span>) =&gt;</span> {
    <span class="hljs-comment">// called when an operation was loaded in from storage and placed back on the queue</span>
    <span class="hljs-comment">// This would happen across app restarts</span>
  },
  queueCleared() {
    <span class="hljs-comment">// called when all operations are fulfilled and the queue is cleared</span>
  }
});
</code></pre>
<p>Below is an example <code>ApolloQueueEntryOperation</code> object.</p>
<pre><code class="hljs css language-js">{
  <span class="hljs-attr">qid</span>: <span class="hljs-string">'client:abc123'</span>
  <span class="hljs-attr">op</span>: { 
    <span class="hljs-attr">context</span>: {
      <span class="hljs-attr">operationName</span>: <span class="hljs-string">'createItem'</span>,
      <span class="hljs-attr">conflictBase</span>: <span class="hljs-literal">undefined</span>,
      <span class="hljs-attr">idField</span>: <span class="hljs-string">'id'</span>,
      <span class="hljs-attr">returnType</span>: <span class="hljs-string">'Item'</span>
    },
    <span class="hljs-attr">mutation</span>: &lt;mutation object parsed by gql&gt;,
    optimisticResponse: &lt;optimistic response object&gt;,
    variables: &lt;mutation variables&gt;
  }
}
</code></pre>
<p><code>ApolloQueueEntryOperation</code> objects have two top level fields:</p>
<ul>
<li><code>qid</code> - Queue ID. This ID is randomly generated and mostly used by the <code>OfflineQueue</code>.</li>
<li><code>op</code> - The operation. In <code>offix-client</code> It's of type <code>MutationOptions</code>, the options object passed into <code>client.offlineMutate</code> with some extra metadata set by <code>offix-client</code>.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="cache"></a><a href="#cache" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache</h2>
<p>Apollo Offline Client strongly leverages Apollo Cache.
Please follow documentation for more information about caching in Apollo GraphQL</p>
<p><a href="https://www.apollographql.com/docs/react/advanced/caching.html">https://www.apollographql.com/docs/react/advanced/caching.html</a></p>
<h3><a class="anchor" aria-hidden="true" id="querying-your-data"></a><a href="#querying-your-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Querying your data</h3>
<p>Cache is used to hold data that can be fetched when client is offline.
To effectively work with cache users can use <code>cache-first</code> fetchPolicy
when performing queries. This policy will try to use local cache in
situations when cache was already populated with the server side data.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">return</span> (
  <span class="hljs-keyword">this</span>.apollo.watchQuery &lt;
  YourType &gt;
  {
    <span class="hljs-attr">query</span>: YOUR_QUERY,
    <span class="hljs-attr">fetchPolicy</span>: <span class="hljs-string">'cache-first'</span>
  }
);
</code></pre>
<p>Cache is going to be refueled by subscriptions, pooling or regular queries happening in UI.</p>
<h2><a class="anchor" aria-hidden="true" id="designing-your-types"></a><a href="#designing-your-types" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Designing your types</h2>
<p>When designing your GraphQL schema types <code>id</code> field will be always required.
We also expect that id will be always queried back from server.
Library will perform business logic assuming that <code>id</code> field will be supplied and returned from server. Without this field some offline functionalities will not work properly.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/0.9.0/client-configuration"><span class="arrow-prev">← </span><span>Client Configuration</span></a><a class="docs-next button" href="/docs/0.9.0/offix-cache"><span>Client Cache</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#querying-local-cache">Querying local cache</a></li><li><a href="#offline-workflow">Offline Workflow</a></li><li><a href="#global-update-functions">Global Update Functions</a></li><li><a href="#making-modifications-when-offline">Making modifications when offline</a></li><li><a href="#listening-for-events">Listening for Events</a></li><li><a href="#cache">Cache</a><ul class="toc-headings"><li><a href="#querying-your-data">Querying your data</a></li></ul></li><li><a href="#designing-your-types">Designing your types</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2020 Offix Contributors</section></footer></div></body></html>